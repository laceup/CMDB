{% extends 'base.html' %} {% block title %}{{gene.name}}{% endblock %} {% block content %}
<div class="gene-heading-div">
  <h1 class=gene-heading><b><i>{{gene.name}}</i></b></h1>
</div>

<div style="margin-top: -41px;" class="container">
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="basic-tab" data-toggle="tab" href="#basic" role="tab" aria-controls="go" aria-selected="false">Basic</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="go-tab" data-toggle="tab" href="#go" role="tab" aria-controls="go" aria-selected="false">Gene Ontology</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="exac-tab" data-toggle="tab" href="#exac" role="tab" aria-controls="exac" aria-selected="false">ExAC</a>
    </li>
    <li class="nav-item">
      <a class="nav-link " id="phenotype-tab" data-toggle="tab" href="#phenotype" role="tab" aria-controls="phenotype" aria-selected="false">Phenotype</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="pathways-tab" data-toggle="tab" href="#pathways" role="tab" aria-controls="pathways" aria-selected="false">Pathways</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="ppi-tab" data-toggle="tab" href="#ppi" role="tab" aria-controls="ppi" aria-selected="false">PPI</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="drug-tab" data-toggle="tab" href="#drug" role="tab" aria-controls="drug-tab" aria-selected="false">Drug</a>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
      <br>
      {% if gene %}
      <div class=container>
        <div class="row basic-table-row">
          <div class="col-sm-2 col-md-2 col-lg-2 basic-table-title">Gene name</div>
          <div class="col-sm-10 col-md-10 col-lg-10 basic-table-content"><span>{{gene.name}}</span></div>
        </div>
        <div class="row basic-table-row" >
          <div class="col-sm-2 col-md-2 col-lg-2 basic-table-title">Protein</div>
          <div class="col-sm-10 col-md-10 col-lg-10 basic-table-content">{{gene.protein_name}}</div>
        </div>
        <div class="row basic-table-row">
          <div class="col-sm-2 col-md-2 col-lg-2 basic-table-title">Ensemble ID </div>
          <div class="col-sm-10 col-md-10 col-lg-10 basic-table-content">
            <a target="_blank" href="https://asia.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g={{gene.ensembl_id}}">{{gene.ensembl_id}}</a>
          </div>
        </div>
        <div class="row basic-table-row">
          <div class="col-sm-2 col-md-2 col-lg-2 basic-table-title">Uniprot IDs</div>
          <div class="col-sm-10 col-md-10 col-lg-10 basic-table-content">
            <a target="_blank" href="https://www.uniprot.org/uniprot/{{gene.uniprot_id}}">{{gene.uniprot_id}}</a>
          </div>
        </div>
        <div class="row basic-table-row">
          <div class="col-sm-2 col-md-2 col-lg-2 basic-table-title">MGI ID</div>
          <div class="col-sm-10 col-md-10 col-lg-10 basic-table-content">
            <a target="_blank" href="http://www.informatics.jax.org/marker/{{gene.mgi_id}}">{{gene.mgi_id}}</a>
          </div>
        </div>
        <div class="row basic-table-row">
          <div class="col-sm-2 col-md-2 col-lg-2 basic-table-title">NCBI ID</div>
          <div class="col-sm-10 col-md-10 col-lg-10 basic-table-content">
            <a target="_blank" href="https://www.ncbi.nlm.nih.gov/gene/{{gene.ncbi_id}}">{{gene.ncbi_id}}</a>
          </div>
        </div>
      </div>
      {% endif %}
            
      <div>
        <hr>
        <h4>Ensemble Info</h4>
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-hover">
            <thead>
              <tr>
                <th>Chromosome Name</th>
                <th>Start BP</th>
                <th>End BP</th>
                <th>Transcript Count</th>
                <th>GC Content(%)</th>
                
              </tr>
            </thead>
            <tbody>
              
              <tr>
                <td>{{gene.ensembl.chromosome_scaffold_name}}</td>
                <td>{{gene.ensembl.start_bp}}</td>
                <td>{{gene.ensembl.end_bp}}</td>
                <td>{{gene.ensembl.transcript_count}}</td>
                <td>{{gene.ensembl.percentage_gc_content}}</td>
                
              </tr>
              
            </tbody>
          </table>
        </div>
        <hr>
        <h3>Subcellular Location</h3>
        <hr>
      </div>
      
    </div>
    <div class="tab-pane fade" id="go" role="tabpanel" aria-labelledby="go-tab">
      <br>
      <div class="table-responsive">
        <table class="download_table cell-border hover stripe" class="table">
          <thead>
            <tr>
              <th class="left-head">GO ID</th>
              <th class="middle-head">GO Definition</th>
              <th class="right-head">Category</th>
            </tr>
          </thead>
          <tbody>
            {% for cc in gene.go_cellular_component %}
            <tr>
              <td>{{cc.go.id}}</td>
              <td>{{cc.go.text}}</td>
              <td>Cellular component</td>
            </tr>
            {% endfor %} {% for mf in gene.go_molecular_function %}
            <tr>
              <td>{{mf.go.id}}</td>
              <td>{{mf.go.text}}</td>
              <td>Molecular Function</td>
            </tr>
            {% endfor %} {% for bp in gene.go_biological_process %}
            <tr>
              <td>{{bp.go.id}}</td>
              <td>{{bp.go.text}}</td>
              <td>Biological Process</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <!-- ExAC -->
    <div class="tab-pane fade" id="exac" role="tabpanel" aria-labelledby="exac-tab">
      <br>
      <div class="table-responsive">
        <table class="download_table cell-border hover stripe" class="table ">
          <thead>
            <tr>
              <th class="left-head">Variant</th>
              <th class="middle-head">Allele Frequency</th>
              <th class="middle-head">Allele Count</th>
              <th class="middle-head">Allele Number</th>
              <th class="right-head">Major Consequence</th>
            </tr>
          </thead>
          <tbody>
            {% for ex in gene.exac %}
            <tr>
              <td>{{ex.variant_id}}</td>
              <td>{{ex.allele_freq}}</td>
              <td>{{ex.allele_count}}</td>
              <td>{{ex.allele_num}}</td>
              <td>{{ex.major_consequence}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <!-- PHENOTYPE -->
    <div class="tab-pane fade" id="phenotype" role="tabpanel" aria-labelledby="phenotype-tab">
      <br>
      <div class="table-responsive">
        <table class="download_table row-border cell-border hover stripe" class="table ">
          <thead>
            <tr>
              <th class="left-head">Mammalian Phenotype ID</th>
              <th class="middle-head">Term</th>
              <th class="right-head">Definition</th>
            </tr>
          </thead>
          <tbody>
            {% for ph in gene.phenotypes %}
            <tr>
              <td>{{ph.phenotype}}</td>
              <td>{{ph.term}}</td>
              <td>{{ph.definition}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <!-- PATHWAYS -->
    <div class="tab-pane fade" id="pathways" role="tabpanel" aria-labelledby="pathways-tab">
      <br>
      <div class="table-responsive">
        <table class="download_table cell-border hover stripe" class="table ">
          <thead>
            <tr>
              <th class="left-head">Pathways</th>
              <th class="middle-head">External ID</th>
              <th class="right-head">Source</th>
            </tr>
          </thead>
          <tbody>
            {% for pa in gene.pathways %}
            <tr>
              <td>{{pa.data}}</td>
              <td>{{pa.external_id}}</td>
              <td>{{pa.source}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- PPI -->
    <div class="tab-pane fade" id="ppi" role="tabpanel" aria-labelledby="ppi-tab">
      <!-- <div id="viz" class="ppi-viz"></div> -->
      <!-- <span id="viz-loading-message">Loading visualisation</span> -->
    </div>

    <!-- DRUG -->
    <div class="tab-pane fade" id="drug" role="tabpanel" aria-labelledby="drug-tab">
      <script src="https://d3js.org/d3.v3.min.js"></script>

    </div>


  </div>
</div>
{% endblock %} {% block extrajs %}
<script>
// -------------  PPI d3 ------------------
  function isRelevant(uniprot_id) {
    var relevant_uniprot_ids = JSON.parse('{{ gene_list|tojson|safe }}')
    return relevant_uniprot_ids.includes(uniprot_id)
  }
  
  function getNodecolor(d){
    if(d.interactor=="{{name}}"){
      return "#479794"
    }
    else if(isRelevant(d.interactor)){
      return "#479794"
    }
    else if(d.organism=="human"){
      return "#324e73"
    }
    else{
      return "#15699b"
    }
  }
  
  
  var isPPINetworkRendered = false;
  function renderPPINetwork() {
    var width = 1060,
    height = 700;
    var svg = d3.select("div#ppi").append("svg")
    .attr("width", width)
    .attr("height", height);
    
    var force = d3.layout.force()
    .size([width, height]);
    //var links =  JSON.parse('{{ link_ppi| tojson | safe}}');
    var data=JSON.parse('{{ data| tojson | safe}}');
    var nodesByName = {};
    
    
    data.nodes.forEach(function (link) {
      link.source = nodeByName('{{name}}','human','{{name}}');//stupidity here
      link.target = nodeByName(link.interactor,link.organism,link.interactor_full);
    });
    var links_final=data.nodes
    var nodes = d3.values(nodesByName);
    
    console.log('node',data.nodes )
    console.log('link',data.links )
    
    var link = svg.selectAll(".link")
    .data(links_final)
    .enter().append("line")
    .attr("class", "link");
    
    
    
    // Create the node circles.
    var node = svg.selectAll(".node")
    .data(nodes)
    .enter().append("circle")
    .attr("class", "node")
    .style("fill", function(d,i){return getNodecolor(d)})
    //.style("fill","#479794")
    // not working
    .on("dblclick", function(d, i) {
      if (isRelevant(d.interactor)) {
        window.location.href = '/uniprot/'+d.interactor;
      } else {
        window.location.href = 'https://www.uniprot.org/uniprot/'+d.interactor;
      }
    })
    .call(force.drag);
    
    var label = svg.selectAll(".mytext")
    .data(nodes)
    .enter()
    .append("text")
    .text(function (d) { return d.interactor; })
    .style("text-anchor", "middle")
    .style("fill", "#332d2d")
    .style("font-family", "Arial")
    .style("font-size", 10);
    // Start the force layout.
    force
    .nodes(nodes)
    .links(links_final)
    .on("tick", tick)
    .linkDistance(100)
    .charge([-800])
    .start();
    
    console.log('node1',node )
    console.log('link2',link )
    
    function tick() {
      link.attr("x1", function (d) { return d.source.x; })
      .attr("y1", function (d) { return d.source.y; })
      .attr("x2", function (d) { return d.target.x; })
      .attr("y2", function (d) { return d.target.y; });
      
      node.attr("r", function (d) { return d.interactor == '{{name}}' ? 18 : 15; })
      .attr("cx", function (d) { return d.x; })
      .attr("cy", function (d) { return d.y; });
      
      label.attr("x", function (d) { return d.x; })
      .attr("y", function (d) { return d.y - 15; });
    }
    
    function nodeByName(interactor,organism,interactor_full) {
      return nodesByName[interactor] || (nodesByName[interactor] = {interactor:interactor,organism:organism,interactor_full:interactor_full});
    }
    
    isPPINetworkRendered = true;
  }

//-------------  Drug d3 ------------------
var isDrugNetworkRendered = false
function renderDrugNetwork() {
  var width = 1060,
  height = 500;
  var svg = d3.select("div#drug").append("svg")
  .attr("width", width)
  .attr("height", height);
  
  var force = d3.layout.force()
  .size([width, height]);
  
  
  var links =  JSON.parse('{{ link| tojson | safe}}');
  var nodesByName = {};
  // var sourcenode = [{}]
  
  // Create nodes for each unique source and target.
  links.forEach(function (link) {
    link.source = nodeByName(link.gene_name);
    link.target = nodeByName(link.drug_id);
  });
  
  var nodes = d3.values(nodesByName);
  console.log('l', nodes)
  var link = svg.selectAll(".link")
  .data(links)
  .enter().append("line")
  .attr("class", "link");
  
  // Create the node circles.
  var node = svg.selectAll(".node")
  .data(nodes)
  .enter().append("circle")
  .attr("class", "node")
  //.attr("r", function(d) {return d.weight * 10;})
  .style("fill", function (d) { return d.name.substring(0, 2) == "DB" ? "#324e73" : "#479794" })
  .call(force.drag);
  
  var label = svg.selectAll(".mytext")
  .data(nodes)
  .enter()
  .append("text")
  .text(function (d) { return d.name; })
  .style("text-anchor", "middle")
  .style("fill", "#332d2d")
  .style("font-family", "Arial")
  .style("font-size", 10);
  // Start the force layout.
  force
  .nodes(nodes)
  .links(links)
  .on("tick", tick)
  .linkDistance(100)
  .charge([-800])
  .start();
  
  function tick() {
    link.attr("x1", function (d) { return d.source.x; })
    .attr("y1", function (d) { return d.source.y; })
    .attr("x2", function (d) { return d.target.x; })
    .attr("y2", function (d) { return d.target.y; });
    
    node.attr("r", function (d) { return d.name.substring(0, 2) == "DB" ? 15 : 18; })
    .attr("cx", function (d) { return d.x; })
    .attr("cy", function (d) { return d.y; });
    
    label.attr("x", function (d) { return d.x; })
    .attr("y", function (d) { return d.y - 15; });
  }
  
  function nodeByName(name) {
    return nodesByName[name] || (nodesByName[name] = { name: name });
  }

  isDrugNetworkRendered = true;
}
// ---------------------------------------
$(document).ready(function () {
  $('.download_table').DataTable({
    dom: 'Bfrtip',
    buttons: [
        'copy', 'csv', 'excel', 'pdf', 'print'
    ]
  });

  $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    if (e.target.id == "ppi-tab") {
      if (!isPPINetworkRendered) {
        renderPPINetwork()
      }
      // break here
      $('span#viz-loading-message').hide()
    }
    
    if (e.target.id == "drug-tab") {
      if (!isDrugNetworkRendered) {
        renderDrugNetwork()
      }
    }
  });
  
});
  
</script> {% endblock %}